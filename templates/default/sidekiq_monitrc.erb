<% @workers.each do |worker, options| %>
  <% sidekiq_timeout = options[:sidekiq_timeout] %>
  <% memory_limit_mb = options[:memory_limit_mb] %>
  <% process_count = options[:process_count] %>
  <% identifier = "#{@application}-#{worker}1" %>
  <% conf_file = "#{@deploy[:deploy_to]}/shared/config/sidekiq_#{worker}1.yml" %>
  <% syslog = @syslog ? "2>&1 | logger -t sidekiq-#{identifier}" : '' %>

check process sidekiq_<%= identifier %>
  matching "sidekiq_<%= identifier %>"
  start program = "/bin/su - <%= @deploy[:user] %> -c 'cd <%= @deploy[:current_path] %> && RAILS_ENV=<%= @deploy[:rails_env] %> SIDEKIQ_PRELOAD= SIDEKIQ_MAXMEM_MB=<%= memory_limit_mb %> SIDEKIQ_COUNT=<%= process_count %> bundle exec sidekiqswarm -C <%= conf_file %> -t <%= sidekiq_timeout %> -r <%= @deploy[:current_path] %> <%= syslog %>'" with timeout 90 seconds
  stop  program = "/bin/su - <%= @deploy[:user] %> -c 'kill -s TERM `pgrep sidekiqswarm`'" with timeout 90 seconds
  group sidekiq_<%= @application %>_group

<% end %>
